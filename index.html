<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>矯正歯科専門医 研修履歴管理システム ver4.1</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
         {
            body { margin: 0; padding: 20px; }
            .no-print { display: none !important; }
            .print-break { page-break-inside: avoid; }
        }
        .training-table { border-collapse: collapse; width: 100%; }
        .training-table th, .training-table td { border: 1px solid #d1d5db; padding: 8px; text-align: center; }
        .valid-period { background-color: #dcfce7; }
        .invalid-period { background-color: #fef2f2; }
        .checkbox-matrix input[type="checkbox"] { transform: scale(1.2); }
        

    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8">
    <div class="max-w-6xl mx-auto px-4">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-center text-blue-800 mb-2">
                <i class="fas fa-tooth mr-3"></i>矯正歯科専門医 研修履歴管理システム ver4.1
            </h1>
            
            <p class="text-center text-sm text-gray-600 mb-8">
                ※本アプリの判定結果は保証できません。利用は自己責任とし、最終判断は学会ホームページをご確認ください。
            </p>

            <!-- 基本設定セクション -->
            <div class="bg-blue-50 rounded-lg p-6 mb-8">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">
                    <i class="fas fa-cog mr-2"></i>基本設定
                </h2>
                
                <!-- 手順説明 -->
                <div class="bg-white border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm text-gray-700 font-medium mb-2">入力の手順</p>
                            <ol class="text-sm text-gray-600 space-y-1">
                                <li>① まず「申請タイプ」を選択してください（新規申請または更新申請）</li>
                                <li>② 次に表示される「申請年度」を選択してください</li>
                                <li>③ 申請要件と研修履歴入力画面が表示されます</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">①申請タイプ</label>
                        <select id="applicationType" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">選択してください</option>
                            <option value="new">新規申請</option>
                            <option value="renewal">更新申請</option>
                        </select>
                    </div>
                    
                    <div id="yearSelectContainer" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700 mb-2">②申請年度</label>
                        <select id="applicationYear" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">選択してください</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 申請要件表示 -->
            <div id="requirementDisplay" class="bg-green-50 rounded-lg p-6 mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-green-800 mb-4">
                    <i class="fas fa-clipboard-list mr-2"></i>申請要件
                </h2>
                <div id="requirementContent"></div>
            </div>

            <!-- 研修履歴入力 -->
            <div id="trainingHistorySection" class="bg-gray-50 rounded-lg p-6 mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-table mr-2"></i>研修履歴入力
                </h2>

                <p class="text-sm text-gray-600 mb-6">
                    ※追加研修は受講日と認定年度が異なるため手入力をしてください。
                </p>


                <div class="overflow-x-auto">
                    <table id="trainingMatrix" class="training-table">
                        <thead>
                            <tr>
                                <th class="bg-gray-200">研修分野</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="bg-gray-100 font-medium">①医療倫理</td>
                            </tr>
                            <tr>
                                <td class="bg-gray-100 font-medium">②患者・医療者関係の構築</td>
                            </tr>
                            <tr>
                                <td class="bg-gray-100 font-medium">③医療安全</td>
                            </tr>
                            <tr>
                                <td class="bg-gray-100 font-medium">④院内感染対策</td>
                            </tr>
                            <tr>
                                <td class="bg-gray-100 font-medium">⑤医療関連法規・医療経済</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 2029年度以降の特別チェックボックス -->
                <div id="specialRequirement2029" class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg" style="display: none;">
                    <label class="flex items-start space-x-3">
                        <input type="checkbox" id="institutionalTrainingCheck" class="mt-1 transform scale-125">
                        <span class="text-sm text-gray-700">
                            共通研修区分「①医療倫理」「②患者・医療者関係の構築」「⑤医療関連法規・医療経済」について、それぞれ1単位（合計3単位）の日本歯科専門医機構主催研修の受講している。
                        </span>
                    </label>
                </div>

                <!-- その他研修追加 -->
                <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">その他研修追加</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">取得年度</label>
                            <input type="number" id="otherYear" class="w-full p-2 border border-gray-300 rounded-md" min="2020" max="2040">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">研修分野</label>
                            <select id="otherField" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="">選択してください</option>
                                <option value="0">①医療倫理</option>
                                <option value="1">②患者・医療者関係の構築</option>
                                <option value="2">③医療安全</option>
                                <option value="3">④院内感染対策</option>
                                <option value="4">⑤医療関連法規・医療経済</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="addOtherTraining" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                追加
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 追加された研修の一覧 -->
            <div id="addedTrainingListSection" class="bg-gray-50 rounded-lg p-6 mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-list mr-2"></i>追加された研修一覧
                </h2>
                <div id="addedTrainingList" class="space-y-2"></div>
            </div>

            <!-- 進捗状況表示 -->
            <div id="progressSection" class="bg-purple-50 rounded-lg p-6 mb-8" style="display: none;">
                <h2 class="text-xl font-semibold text-purple-800 mb-4">
                    <i class="fas fa-chart-line mr-2"></i>進捗状況
                </h2>
                <div id="progressContent"></div>
            </div>

            <!-- 操作ボタン -->
            <div id="saveButtonSection" class="flex justify-center space-x-4 no-print" style="display: none;">
                <button id="saveBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    <i class="fas fa-print mr-2"></i>保存（印刷）
                </button>
            </div>
        </div>
    </div>

    <script>
        let trainingData = {};
        let currentApplicationType = '';
        let currentApplicationYear = '';
        let addedTrainingList = [];

        // 追加研修を表示する関数
        function updateAddedTrainingDisplay() {
            const listContainer = document.getElementById('addedTrainingList');
            const listSection = document.getElementById('addedTrainingListSection');
            
            if (addedTrainingList.length === 0) {
                listSection.style.display = 'none';
                return;
            }
            
            listSection.style.display = 'block';
            
            const fieldNames = [
                '①医療倫理',
                '②患者・医療者関係の構築',
                '③医療安全',
                '④院内感染対策',
                '⑤医療関連法規・医療経済'
            ];
            
            listContainer.innerHTML = addedTrainingList.map((item, index) => `
                <div class="flex items-center justify-between bg-white p-3 rounded-md border border-gray-200">
                    <div class="flex-1">
                        <span class="font-medium text-gray-800">${item.year}年度</span>
                        <span class="mx-2 text-gray-400">|</span>
                        <span class="text-gray-700">${fieldNames[item.field]}</span>
                    </div>
                    <button onclick="removeAddedTraining(${index})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // 追加研修を削除する関数
        function removeAddedTraining(index) {
            // リストから削除（チェックボックスはそのまま）
            addedTrainingList.splice(index, 1);
            
            // 表示を更新
            updateAddedTrainingDisplay();
            updateProgress();
        }



        // 申請タイプ変更時の処理
        document.getElementById('applicationType').addEventListener('change', function() {
            const type = this.value;
            currentApplicationType = type;
            const yearSelect = document.getElementById('applicationYear');
            const yearSelectContainer = document.getElementById('yearSelectContainer');
            
            if (!type) {
                yearSelectContainer.style.display = 'none';
                hideAllSections();
                return;
            }
            
            // ②申請年度を表示
            yearSelectContainer.style.display = 'block';
            
            yearSelect.innerHTML = '<option value="">選択してください</option>';
            
            if (type === 'new') {
                for (let year = 2026; year <= 2035; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + '年';
                    yearSelect.appendChild(option);
                }
            } else if (type === 'renewal') {
                const renewalOptions = [
                    { year: 2026, text: '2026年度申請（専門医期限2027年3月31日）' },
                    { year: 2027, text: '2027年度申請（専門医期限2028年3月31日）' },
                    { year: 2028, text: '2028年度申請（専門医期限2029年3月31日）' },
                    { year: 2029, text: '2029年度申請（専門医期限2030年3月31日）' },
                    { year: 2030, text: '2030年度申請（専門医期限2031年3月31日）' },
                    { year: 2031, text: '2031年度申請（専門医期限2032年3月31日）' },
                    { year: 2032, text: '2032年度申請（専門医期限2033年3月31日）' },
                    { year: 2033, text: '2033年度申請（専門医期限2034年3月31日）' },
                    { year: 2034, text: '2034年度申請（専門医期限2035年3月31日）' },
                    { year: 2035, text: '2035年度申請（専門医期限2036年3月31日）' }
                ];
                
                renewalOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.year;
                    option.textContent = opt.text;
                    yearSelect.appendChild(option);
                });
            }
            
            hideAllSections();
        });

        // 申請年度変更時の処理
        document.getElementById('applicationYear').addEventListener('change', function() {
            const year = parseInt(this.value);
            currentApplicationYear = year;
            
            if (year && currentApplicationType) {
                showRequirements();
                generateTrainingMatrix();
                showProgressSection();
                checkSpecialRequirement2029();
                // 保存ボタンを表示
                document.getElementById('saveButtonSection').style.display = 'flex';
            } else {
                hideAllSections();
            }
        });

        function hideAllSections() {
            document.getElementById('requirementDisplay').style.display = 'none';
            document.getElementById('trainingHistorySection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('specialRequirement2029').style.display = 'none';
            document.getElementById('saveButtonSection').style.display = 'none';
        }

        function showRequirements() {
            const requirementDiv = document.getElementById('requirementDisplay');
            const contentDiv = document.getElementById('requirementContent');
            
            let targetPeriod, requiredUnits, fieldRequirement;
            
            if (currentApplicationType === 'new') {
                // 新規申請の計算
                if (currentApplicationYear <= 2027) {
                    targetPeriod = `2022年〜${currentApplicationYear - 1}年`;
                } else {
                    targetPeriod = `${currentApplicationYear - 5}年〜${currentApplicationYear - 1}年`;
                }
                
                if (currentApplicationYear === 2026) {
                    requiredUnits = '8単位';
                    fieldRequirement = '分野別の最低単位数制限なし';
                } else {
                    requiredUnits = '10単位以上';
                    if (currentApplicationYear >= 2029) {
                        fieldRequirement = '①～⑤の研修項目から各1分野から１単位以上を取得することが必須<br>そのうち①医療倫理、②患者・医療者関係の構築、⑤医療関連法規・医療経済については、専門医機構主催の共通研修で各1単位（合計3単位）の受講が必須';
                    } else {
                        fieldRequirement = '各分野から1単位以上必須';
                    }
                }
            } else {
                // 更新申請の計算
                targetPeriod = `${currentApplicationYear - 5}年〜${currentApplicationYear - 1}年`;
                requiredUnits = '10単位';
                if (currentApplicationYear === 2026) {
                    fieldRequirement = '分野別の最低単位数制限なし';
                } else if (currentApplicationYear >= 2029) {
                    fieldRequirement = '①～⑤の研修項目から各1分野から１単位以上を取得することが必須<br>そのうち①医療倫理、②患者・医療者関係の構築、⑤医療関連法規・医療経済については、専門医機構主催の共通研修で各1単位（合計3単位）の受講が必須';
                } else {
                    fieldRequirement = '各分野から1単位以上必須';
                }
            }
            
            contentDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="font-semibold text-green-700 mb-2">対象期間</h3>
                        <p class="text-lg">${targetPeriod}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="font-semibold text-green-700 mb-2">必要単位数</h3>
                        <p class="text-lg">${requiredUnits}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="font-semibold text-green-700 mb-2">分野別要件</h3>
                        <p class="text-sm">${fieldRequirement}</p>
                    </div>
                </div>
            `;
            
            requirementDiv.style.display = 'block';
        }

        function generateTrainingMatrix() {
            const table = document.getElementById('trainingMatrix');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            
            // 年度範囲を計算（申請年度を含む過去7年）
            const startYear = currentApplicationYear - 6;
            const endYear = currentApplicationYear;
            
            // ヘッダーを再構築
            thead.innerHTML = '<th class="bg-gray-200">研修分野</th>';
            for (let year = startYear; year <= endYear; year++) {
                const th = document.createElement('th');
                th.className = 'bg-gray-200';
                th.textContent = year + '年';
                thead.appendChild(th);
            }
            
            // 対象期間を計算
            let validStartYear, validEndYear;
            if (currentApplicationType === 'new') {
                if (currentApplicationYear <= 2027) {
                    validStartYear = 2022;
                    validEndYear = currentApplicationYear - 1;
                } else {
                    validStartYear = currentApplicationYear - 5;
                    validEndYear = currentApplicationYear - 1;
                }
            } else {
                validStartYear = currentApplicationYear - 5;
                validEndYear = currentApplicationYear - 1;
            }
            
            // ボディを再構築
            const fields = ['①医療倫理', '②患者・医療者関係の構築', '③医療安全', '④院内感染対策', '⑤医療関連法規・医療経済'];
            tbody.innerHTML = '';
            
            fields.forEach((field, fieldIndex) => {
                const row = document.createElement('tr');
                
                const fieldCell = document.createElement('td');
                fieldCell.className = 'bg-gray-100 font-medium';
                fieldCell.textContent = field;
                row.appendChild(fieldCell);
                
                for (let year = startYear; year <= endYear; year++) {
                    const cell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'transform scale-125';
                    checkbox.dataset.year = year;
                    checkbox.dataset.field = fieldIndex;
                    
                    // 対象期間かどうかで色分け
                    if (year >= validStartYear && year <= validEndYear) {
                        cell.className = 'valid-period';
                    } else {
                        cell.className = 'invalid-period';
                    }
                    
                    checkbox.addEventListener('change', updateProgress);
                    cell.appendChild(checkbox);
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            });
            
            document.getElementById('trainingHistorySection').style.display = 'block';
        }




        function recognizeTrainingInfo(text) {
            const result = { year: null, field: -1, confidence: 0 };
            
            // 正確な年度認識（日本の年度制に対応）
            let fiscalYear = null;
            
            // より詳細な日付パターンを検索
            const datePatterns = [
                // 基本的な日付パターン
                /(20[2-3][0-9])年\s*([0-1]?[0-9])\s*月\s*([0-3]?[0-9])\s*日/g,
                /(20[2-3][0-9])\/([0-1]?[0-9])\/([0-3]?[0-9])/g,
                /(20[2-3][0-9])-([0-1]?[0-9])-([0-3]?[0-9])/g,
                /(20[2-3][0-9])\.([0-1]?[0-9])\.([0-3]?[0-9])/g,
                // 月が先に来るパターン
                /([0-1]?[0-9])月\s*([0-3]?[0-9])日.*?(20[2-3][0-9])年/g,
                // 年月のみのパターン
                /(20[2-3][0-9])年\s*([0-1]?[0-9])\s*月/g
            ];
            
            const foundDates = [];
            
            datePatterns.forEach((pattern, patternIndex) => {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    let year, month;
                    
                    if (patternIndex === 4) {
                        // 月日年の順序パターン
                        month = parseInt(match[1]);
                        year = parseInt(match[3]);
                    } else {
                        // 通常の年月日パターン
                        year = parseInt(match[1]);
                        month = parseInt(match[2]);
                    }
                    
                    // 有効な年月かチェック
                    if (year >= 2020 && year <= 2040 && month >= 1 && month <= 12) {
                        // 日本の年度計算を正確に実行
                        let calculatedFiscalYear;
                        if (month >= 1 && month <= 3) {
                            // 1-3月は前年度
                            calculatedFiscalYear = year - 1;
                        } else if (month >= 4 && month <= 12) {
                            // 4-12月は当年度
                            calculatedFiscalYear = year;
                        }
                        
                        foundDates.push({
                            originalYear: year,
                            month: month,
                            fiscalYear: calculatedFiscalYear,
                            confidence: 1.0
                        });
                    }
                }
            });
            
            // 最も新しい有効な日付を選択
            if (foundDates.length > 0) {
                const bestDate = foundDates.reduce((best, current) => {
                    if (current.originalYear > best.originalYear) return current;
                    if (current.originalYear === best.originalYear && current.month > best.month) return current;
                    return best;
                });
                fiscalYear = bestDate.fiscalYear;
            } else {
                // 日付が見つからない場合、年度表記を直接検索
                const yearOnlyPatterns = [
                    /(20[2-3][0-9])年度/g,
                    /(20[2-3][0-9])年/g
                ];
                
                const foundYears = [];
                yearOnlyPatterns.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(text)) !== null) {
                        const year = parseInt(match[1]);
                        if (year >= 2020 && year <= 2040) {
                            foundYears.push(year);
                        }
                    }
                });
                
                if (foundYears.length > 0) {
                    fiscalYear = Math.max(...foundYears);
                }
            }
            
            result.year = fiscalYear;

            // 高精度分野認識（既存のロジックを維持）
            let maxScore = 0;
            let bestField = -1;

            for (let fieldIndex = 0; fieldIndex < 5; fieldIndex++) {
                const keywords = fieldKeywords[fieldIndex];
                let score = 0;

                // 主要キーワードのスコア計算（高い重み）
                keywords.primary.forEach(keyword => {
                    const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    const matches = text.match(regex);
                    if (matches) {
                        score += matches.length * 10; // 主要キーワードは高スコア
                    }
                });

                // 二次キーワードのスコア計算（中程度の重み）
                keywords.secondary.forEach(keyword => {
                    const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    const matches = text.match(regex);
                    if (matches) {
                        score += matches.length * 5;
                    }
                });

                // コンテキストキーワードのスコア計算（低い重み）
                keywords.context.forEach(keyword => {
                    const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    const matches = text.match(regex);
                    if (matches) {
                        score += matches.length * 2;
                    }
                });

                // 複合語でのボーナススコア
                if (fieldIndex === 0 && (text.includes('医療倫理') || text.includes('生命倫理'))) {
                    score += 15;
                }
                if (fieldIndex === 1 && (text.includes('患者・医療者') || text.includes('コミュニケーション'))) {
                    score += 15;
                }
                if (fieldIndex === 2 && (text.includes('医療安全') || text.includes('安全管理'))) {
                    score += 15;
                }
                if (fieldIndex === 3 && (text.includes('院内感染') || text.includes('感染対策'))) {
                    score += 15;
                }
                if (fieldIndex === 4 && (text.includes('医療法') || text.includes('診療報酬') || text.includes('医療経済'))) {
                    score += 15;
                }

                if (score > maxScore) {
                    maxScore = score;
                    bestField = fieldIndex;
                }
            }

            if (maxScore > 5) { // 最低スコア閾値
                result.field = bestField;
                result.confidence = Math.min(maxScore / 20, 1.0); // 信頼度を0-1に正規化
            }

            return result;
        }

        function showRecognitionDialog(recognition, fileName) {
            const fieldNames = ['医療倫理', '患者・医療者関係の構築', '医療安全', '院内感染対策', '医療関連法規・医療経済'];
            const fieldName = fieldNames[recognition.field];
            
            const confidence = Math.round(recognition.confidence * 100);
            
            if (confirm(`${fileName}\n\n認識結果:\n年度: ${recognition.year}年度\n分野: ①${fieldName}\n信頼度: ${confidence}%\n\nこの内容で研修履歴に追加しますか？`)) {
                // 該当するチェックボックスを探してチェック
                const checkbox = document.querySelector(`input[data-year="${recognition.year}"][data-field="${recognition.field}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    updateProgress();
                    alert('研修履歴に追加しました。');
                } else {
                    alert('指定された年度は表示範囲外です。');
                }
            }
        }

        function checkSpecialRequirement2029() {
            const specialDiv = document.getElementById('specialRequirement2029');
            if (currentApplicationYear >= 2029) {
                specialDiv.style.display = 'block';
                document.getElementById('institutionalTrainingCheck').addEventListener('change', updateProgress);
            } else {
                specialDiv.style.display = 'none';
            }
        }

        function showProgressSection() {
            document.getElementById('progressSection').style.display = 'block';
            updateProgress();
        }

        function updateProgress() {
            const progressContent = document.getElementById('progressContent');
            const fields = ['医療倫理', '患者・医療者関係の構築', '医療安全', '院内感染対策', '医療関連法規・医療経済'];
            
            // 対象期間を計算
            let validStartYear, validEndYear;
            if (currentApplicationType === 'new') {
                if (currentApplicationYear <= 2027) {
                    validStartYear = 2022;
                    validEndYear = currentApplicationYear - 1;
                } else {
                    validStartYear = currentApplicationYear - 5;
                    validEndYear = currentApplicationYear - 1;
                }
            } else {
                validStartYear = currentApplicationYear - 5;
                validEndYear = currentApplicationYear - 1;
            }
            
            // 各分野の単位数を計算
            const fieldCounts = [0, 0, 0, 0, 0];
            let totalUnits = 0;
            
            // チェックボックスからカウント
            document.querySelectorAll('#trainingMatrix input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const year = parseInt(checkbox.dataset.year);
                    const field = parseInt(checkbox.dataset.field);
                    
                    if (year >= validStartYear && year <= validEndYear) {
                        fieldCounts[field]++;
                        totalUnits++;
                    }
                }
            });
            
            // 追加研修リストからカウント（重複を許可）
            addedTrainingList.forEach(item => {
                if (item.year >= validStartYear && item.year <= validEndYear) {
                    fieldCounts[item.field]++;
                    totalUnits++;
                }
            });
            
            // 必要単位数を設定
            let requiredUnits;
            if (currentApplicationType === 'new' && currentApplicationYear === 2026) {
                requiredUnits = 8;
            } else {
                requiredUnits = 10;
            }
            
            // 分野別要件をチェック
            let fieldRequirementMet = true;
            let fieldRequirementText = '';
            
            if (currentApplicationType === 'new' && currentApplicationYear === 2026) {
                fieldRequirementMet = true;
                fieldRequirementText = '分野別制限なし';
            } else {
                fieldRequirementText = '各分野1単位以上必要';
                fieldCounts.forEach(count => {
                    if (count === 0) fieldRequirementMet = false;
                });
            }
            
            // 2029年度以降の特別要件チェック
            let institutionalRequirementMet = true;
            if (currentApplicationYear >= 2029) {
                const institutionalCheck = document.getElementById('institutionalTrainingCheck');
                institutionalRequirementMet = institutionalCheck && institutionalCheck.checked;
            }
            
            // 総合判定
            const totalRequirementMet = totalUnits >= requiredUnits;
            const allRequirementsMet = totalRequirementMet && fieldRequirementMet && institutionalRequirementMet;
            
            // 進捗表示を生成
            let progressHTML = `
                <!-- 取得単位数 -->
                <div class="bg-white p-4 rounded-lg border mb-6">
                    <h3 class="font-semibold text-purple-700 mb-3">取得単位数</h3>
                    <div class="flex items-center space-x-4">
                        <div class="text-2xl font-bold ${totalRequirementMet ? 'text-green-600' : 'text-red-600'}">
                            ${totalUnits} / ${requiredUnits}
                        </div>
                        <div class="flex-1 bg-gray-200 rounded-full h-3">
                            <div class="bg-${totalRequirementMet ? 'green' : 'red'}-500 h-3 rounded-full transition-all duration-300" 
                                 style="width: ${Math.min(totalUnits / requiredUnits * 100, 100)}%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 分野別進捗状況 -->
                <div class="bg-white p-4 rounded-lg border mb-6">
                    <h3 class="font-semibold text-purple-700 mb-3">分野別進捗状況</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            `;
            
            fields.forEach((field, index) => {
                const count = fieldCounts[index];
                const required = (currentApplicationType === 'new' && currentApplicationYear === 2026) ? 0 : 1;
                const met = count >= required;
                
                progressHTML += `
                    <div class="text-center p-3 rounded-lg ${met ? 'bg-green-100' : 'bg-red-100'}">
                        <div class="font-medium text-sm mb-1">①${field}</div>
                        <div class="text-lg font-bold ${met ? 'text-green-600' : 'text-red-600'}">
                            ${count} / ${required}
                        </div>
                        <div class="text-xs ${met ? 'text-green-600' : 'text-red-600'}">
                            ${met ? '✅' : '❌'}
                        </div>
                    </div>
                `;
            });
            
            progressHTML += '</div></div>';
            
            // 判定結果を追加
            progressHTML += `
                <!-- 判定結果 -->
                <div class="bg-white p-4 rounded-lg border mb-6">
                    <h3 class="font-semibold text-purple-700 mb-3">判定結果</h3>
                    <div class="text-center">
                        <div class="text-3xl font-bold ${allRequirementsMet ? 'text-green-600' : 'text-red-600'}">
                            ${allRequirementsMet ? '✅ 申請可能' : '❌ 申請不可'}
                        </div>
                    </div>
                </div>
            `;
            
            // 不足項目の表示
            if (!allRequirementsMet) {
                progressHTML += '<div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg"><h4 class="font-semibold text-red-700 mb-2">不足項目</h4><ul class="text-sm text-red-600 space-y-1">';
                
                if (!totalRequirementMet) {
                    progressHTML += `<li>• 総単位数が${requiredUnits - totalUnits}単位不足しています</li>`;
                }
                
                if (!fieldRequirementMet) {
                    fieldCounts.forEach((count, index) => {
                        if (count === 0) {
                            progressHTML += `<li>• ${fields[index]}の単位が不足しています</li>`;
                        }
                    });
                }
                
                if (!institutionalRequirementMet) {
                    progressHTML += '<li>• 機構主催研修の受講確認が必要です</li>';
                }
                
                progressHTML += '</ul></div>';
            }
            
            progressContent.innerHTML = progressHTML;
        }

        // その他研修追加機能
        document.getElementById('addOtherTraining').addEventListener('click', function() {
            const year = parseInt(document.getElementById('otherYear').value);
            const field = parseInt(document.getElementById('otherField').value);
            
            if (!year || field === '') {
                alert('年度と分野を選択してください');
                return;
            }
            
            // 追加研修リストに追加（重複を許可）
            addedTrainingList.push({year: year, field: field});
            
            // 該当するチェックボックスがあればチェック
            const checkbox = document.querySelector(`input[data-year="${year}"][data-field="${field}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
            
            // 表示を更新
            updateAddedTrainingDisplay();
            updateProgress();
            
            // フィールドをクリア
            document.getElementById('otherYear').value = '';
            document.getElementById('otherField').value = '';
        });

        document.getElementById('saveBtn').addEventListener('click', function() {
            window.print();
        });

        document.addEventListener('DOMContentLoaded', function() {
        });
    </script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDjz8PmRlUhN3i8H7%2FL2Hk3JB94h%2BASdgqHZbF8brJobJRxUgnuR2UWhuTXl4WcyPeVF3%2FTP6v8XS7cYZP5NfAUPICl6GvmWCrYVXcL9qEW%2BRM27LegNO92B7jSqyAj0L43FadGxoRolOFerLiCFr8tJWIFOlT1MJxNxtyLePgX5gVTcTnFEn3z0d0Ku48UYRRMIUcshd1zkZgU2LM%2BKU3lk%2F7olVWCulC6lN6W0tMUUpVTOouMEeljnhb8QBNymHcORhKiTHJw4lVOLJDwPFmnnCKM9K%2Ft9Tg2DbPXfAYDelA7TJ51L%2BgXulwhCXuLkq5X24ARIjQ2oPWPaxHQBr7%2F2wXbAJFFvnFcLaUCJSp0WvIZQoPgKrPRd1uVIY0WytJ6bhoCmPFUz6M%2B9ni1xeZxA01YyXrv%2BkKVsH8ZPeY2p%2F70JIpX5Sn16iYb%2BP8PhIYSIKIJwjLlUU9D5X7xbk2eSuw5YIYFyB2pDoQOzBOg5kxdEQCtViz4IwdV351V4iNmDo8sCNeMel%2BAn%2Bq7zLPihUWmgtIuLyIgltg9Qlx%2F6H";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDjz8PmRlUhN3i8H7/L2Hk3JB94h+ASdgqHZbF8brJobJRxUgnuR2UWhuTXl4WcyPeVF3/TP6v8XS7cYZP5NfAUPICl6GvmWCrYVXcL9qEW+RM27LegNO92B7jSqyAj0L43FadGxoRolOFerLiCFr8tJWIFOlT1MJxNxtyLePgX5gVTcTnFEn3z0d0Ku48UYRRMIUcshd1zkZgU2LM+KU3lk/7olVWCulC6lN6W0tMUUpVTOouMEeljnhb8QBNymHcORhKiTHJw4lVOLJDwPFmnnCKM9K/t9Tg2DbPXfAYDelA7TJ51L+gXulwhCXuLkq5X24ARIjQ2oPWPaxHQBr7/2wXbAJFFvnFcLaUCJSp0WvIZQoPgKrPRd1uVIY0WytJ6bhoCmPFUz6M+9ni1xeZxA01YyXrv+kKVsH8ZPeY2p/70JIpX5Sn16iYb+P8PhIYSIKIJwjLlUU9D5X7xbk2eSuw5YIYFyB2pDoQOzBOg5kxdEQCtViz4IwdV351V4iNmDo8sCNeMel+An+q7zLPihUWmgtIuLyIgltg9Qlx/6H";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    
